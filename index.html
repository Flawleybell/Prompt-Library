<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prompt Library (No-Install, Full CRUD)</title>

  <style>
    :root { 
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --secondary:#64748b;
      --border:#e2e8f0;
      --muted:#64748b;
      --bg:#f8fafc;
      --card-bg:#ffffff;
      --text:#0f172a;
      --text-muted:#475569;
      --success:#059669;
      --danger:#dc2626;
      --warning:#d97706;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:32px 24px;
    }
    
    .header{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px 32px;
      margin-bottom:24px;
      box-shadow:var(--shadow);
    }
    
    .header-content{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
      flex-wrap:wrap;
    }
    
    .header-title {
      display:flex;
      align-items:center;
      gap:16px;
    }
    
    .logo {
      height:40px;
      width:auto;
    }
    
    .title {
      font-size:28px;
      font-weight:700;
      color:var(--text);
      margin:0;
      letter-spacing:-0.025em;
    }
    
    .hstack{display:flex;align-items:center;gap:12px}
    .hstack-wrap{display:flex;flex-wrap:wrap;align-items:center;gap:12px}
    
    .button{
      padding:10px 20px;
      border:1px solid var(--border);
      background:var(--card-bg);
      cursor:pointer;
      border-radius:8px;
      font-weight:500;
      font-size:14px;
      transition:all 0.2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    
    .button:hover{
      background:#f1f5f9;
      border-color:var(--primary);
      transform:translateY(-1px);
      box-shadow:var(--shadow);
    }
    
    .button.primary{
      background:var(--primary);
      color:white;
      border-color:var(--primary);
    }
    
    .button.primary:hover{
      background:var(--primary-hover);
      transform:translateY(-1px);
      box-shadow:var(--shadow-lg);
    }
    
    .button.ghost{
      border-color:transparent;
      background:transparent;
      color:var(--text-muted);
      padding:8px 12px;
    }
    
    .button.ghost:hover{
      background:#f1f5f9;
      color:var(--text);
    }
    
    .button.danger{
      border-color:#fecaca;
      color:var(--danger);
      background:#fef2f2;
    }
    
    .button.danger:hover{
      background:#fee2e2;
      border-color:var(--danger);
    }
    
    .input,.select,.textarea{
      width:100%;
      padding:12px 16px;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card-bg);
      font-size:14px;
      transition:all 0.2s ease;
    }
    
    .input:focus,.select:focus,.textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .grid{display:grid;gap:16px}
    
    .filter-grid{
      display:grid;
      grid-template-columns:2fr 1fr 1fr 1fr;
      gap:16px;
      align-items:end;
    }
    
    @media (max-width: 768px){
      .filter-grid{grid-template-columns:1fr}
    }
    
    .two-column-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      align-items:start;
    }
    
    @media (max-width: 980px){ 
      .two-column-grid{grid-template-columns:1fr}
    }
    
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card-bg);
      box-shadow:var(--shadow);
      transition:all 0.2s ease;
      overflow:hidden;
    }
    
    .card:hover{
      box-shadow:var(--shadow-lg);
      transform:translateY(-2px);
    }
    
    .card-header{
      padding:20px 24px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .card-body{padding:24px}
    
    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--text);
      margin:0 0 4px 0;
    }
    
    .card-meta{
      color:var(--text-muted);
      font-size:13px;
      font-weight:500;
    }
    
    .badge{
      display:inline-block;
      background:var(--chip);
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:500;
      margin:2px 4px 2px 0;
      border:1px solid #bfdbfe;
      color:var(--primary);
    }
    
    .badge.channel{
      background:#f0fdf4;
      border-color:#bbf7d0;
      color:var(--success);
    }
    
    .muted{color:var(--text-muted);font-size:14px;line-height:1.6}
    
    pre,code{
      font-family:'JetBrains Mono', 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:6px;
      padding:16px;
      font-size:13px;
      line-height:1.5;
    }
    
    .clamp{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      white-space:pre-wrap;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:6px;
      padding:16px;
      font-family:'JetBrains Mono', monospace;
      font-size:13px;
      line-height:1.5;
    }
    
    .chip-toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border:1px solid var(--border);
      border-radius:8px;
      cursor:pointer;
      background:var(--card-bg);
      font-weight:500;
      transition:all 0.2s ease;
    }
    
    .chip-toggle:hover{
      background:#f1f5f9;
      border-color:var(--primary);
    }
    
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15, 23, 42, 0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:1000;
      backdrop-filter:blur(4px);
    }
    
    .modal{
      max-width:800px;
      width:100%;
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--border);
      overflow:hidden;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      animation:modalSlide 0.2s ease;
    }
    
    @keyframes modalSlide {
      from { opacity:0; transform:scale(0.95) translateY(-10px); }
      to { opacity:1; transform:scale(1) translateY(0); }
    }
    
    .filter-card{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:12px;
      padding:24px;
      margin-bottom:24px;
      box-shadow:var(--shadow);
    }
    
    .filter-header{
      font-size:16px;
      font-weight:600;
      color:var(--text);
      margin-bottom:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .hidden { display: none; }
    
    .purpose-text{
      color:var(--text-muted);
      font-style:italic;
      margin-bottom:12px;
      font-size:14px;
    }
    
    .notes-text{
      background:#fefce8;
      border:1px solid #fde047;
      border-radius:6px;
      padding:12px;
      margin-top:12px;
      font-size:13px;
      color:#713f12;
    }
    
    .action-buttons{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    .footer{
      text-align:center;
      padding:32px 0;
      color:var(--text-muted);
      font-size:14px;
      border-top:1px solid var(--border);
      margin-top:40px;
      background:var(--card-bg);
      border-radius:12px;
    }
    
    /* Form styling */
    .form-group{
      margin-bottom:20px;
    }
    
    .form-label{
      display:block;
      margin-bottom:6px;
      font-weight:500;
      color:var(--text);
      font-size:14px;
    }
  </style>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <script>
    // Password protection
    (function() {
      var password = prompt("Enter password to view this page:");
      if (password !== "CIA123") {
        document.body.innerHTML = "<div style='text-align:center;margin-top:100px;font-family:Arial'><h2>Access denied</h2></div>";
        return;
      }
    })();
  </script>

  <div class="container">
    <!-- Professional Header -->
    <div class="header">
      <div class="header-content">
        <div class="header-title">
          <img src="https://flawleybell.github.io/Prompt-Library/logo.svg" alt="Ophelos Logo" class="logo" />
          <h1 class="title">Prompt Library</h1>
        </div>
        
        <div class="hstack-wrap">
          <label class="chip-toggle">
            <input type="checkbox" id="compactToggle" onchange="toggleCompact()"/>
            <span>Compact view</span>
          </label>
          
          <div class="hstack-wrap">
            <button class="button" onclick="addCategory()">‚ûï Add Category</button>
            <button class="button" onclick="importItems()">üì• Import</button>
            <button class="button" onclick="exportFiltered()">üì§ Export Filtered</button>
            <button class="button primary" onclick="exportAll()">üíæ Export All</button>
            <button class="button primary" onclick="startNew()">‚ú® New Prompt</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Filters -->
    <div class="filter-card">
      <div class="filter-header">
        üîç Search & Filter
      </div>
      <div class="filter-grid">
        <div class="form-group">
          <label class="form-label">Search</label>
          <input class="input" id="searchInput" placeholder="Search prompts, tags, notes..." oninput="filterPrompts()"/>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="select" id="categoryFilter" onchange="filterPrompts()">
            <option>All Categories</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Tag</label>
          <input class="input" id="tagFilter" placeholder="Filter by tag" oninput="filterPrompts()"/>
        </div>
        <div class="form-group">
          <label class="form-label">Channel</label>
          <select class="select" id="channelFilter" onchange="filterPrompts()">
            <option value="">All Channels</option>
            <option>Front</option>
            <option>ElevenLabs</option>
            <option>Voice</option>
            <option>Email</option>
            <option>SMS</option>
            <option>Chat</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="two-column-grid" id="promptsContainer">
      <!-- Prompts will be loaded here -->
    </div>

    <!-- Professional Footer -->
    <div class="footer">
      <strong>Ophelos Prompt Library</strong> ‚Ä¢ Stored locally in your browser ‚Ä¢ Use Export to backup or share with teammates
    </div>
  </div>

  <!-- Enhanced Editor Modal -->
  <div class="modal-backdrop hidden" id="editorModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="card-header">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:20px;font-weight:600;color:var(--text)" id="modalTitle">‚ú® New Prompt</div>
          <button class="button" onclick="closeEditor()">‚úï Close</button>
        </div>
      </div>
      <div class="card-body">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:20px">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="select" id="editCategory"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Name</label>
            <input class="input" id="editName" placeholder="e.g. IDV ‚Äì Standard"/>
          </div>
          <div class="form-group" style="grid-column:span 2">
            <label class="form-label">Purpose</label>
            <input class="input" id="editPurpose" placeholder="Brief description of why this prompt exists"/>
          </div>
          <div class="form-group" style="grid-column:span 2">
            <label class="form-label">Prompt Text</label>
            <textarea class="textarea" rows="8" id="editPrompt" placeholder="Enter the actual prompt text here..."></textarea>
          </div>
          <div class="form-group" style="grid-column:span 2">
            <label class="form-label">Notes</label>
            <textarea class="textarea" rows="3" id="editNotes" placeholder="Compliance notes, usage instructions, etc."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Tags</label>
            <input class="input" id="editTags" placeholder="compliance, intro, urgent"/>
          </div>
          <div class="form-group">
            <label class="form-label">Channels</label>
            <div class="hstack-wrap" id="channelToggles"></div>
          </div>
          <div style="grid-column:span 2;margin-top:8px" class="hstack" >
            <button class="button" onclick="closeEditor()">Cancel</button>
            <button class="button primary" onclick="savePrompt()">üíæ Save Prompt</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // App state
    let prompts = [];
    let categories = ['IDV','Disputes','Vulnerability','Payments','Closures','Escalations','General'];
    let channels = ['Front','ElevenLabs','Voice','Email','SMS','Chat'];
    let currentEdit = null;
    let compactMode = true;
    let expandedIds = new Set();

    // Sample data with enhanced structure
    const sampleData = [
      { 
        id: 'sample-1', 
        category: 'IDV', 
        name: 'IDV ‚Äì Standard', 
        purpose: 'Confirm identity before account details.', 
        prompt: 'For security, I need to confirm a few details before we continue. Could you please confirm your surname?', 
        notes: 'Use after intro, before giving any account details.', 
        tags: ['compliance', 'intro'], 
        channels: ['Voice', 'Front'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      },
      { 
        id: 'sample-2', 
        category: 'Disputes', 
        name: 'Balance not recognised ‚Äì holding', 
        purpose: 'Acknowledge and move to dispute flow without defensiveness.', 
        prompt: 'Thanks for letting me know. I won\'t go into details until this is checked. I can raise a dispute so the team can investigate. Could you tell me briefly what doesn\'t look right?', 
        notes: 'Keep neutral; capture summary + evidence.', 
        tags: ['dispute', 'holding'], 
        channels: ['Voice', 'Chat'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      },
      { 
        id: 'sample-3', 
        category: 'Vulnerability', 
        name: 'TEXAS ‚Äì consent line', 
        purpose: 'Gain explicit consent to note circumstances.', 
        prompt: 'So that we can support you in the best way going forward, would it be okay for us to make a note of your circumstances on your account? This information may be shared with {Client} and you can ask us to remove this information at any time, just let us know.', 
        notes: 'Exact wording per internal guidance.', 
        tags: ['vulnerability', 'consent', 'TEXAS'], 
        channels: ['Voice', 'Front', 'Chat'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      }
    ];

    // Utility functions
    function uid() { 
      return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 10); 
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Data management
    function loadData() {
      try {
        const saved = localStorage.getItem('promptlib.v1.items');
        prompts = saved ? JSON.parse(saved) : sampleData;
        const savedCats = localStorage.getItem('promptlib.v1.categories');
        if (savedCats) categories = JSON.parse(savedCats);
      } catch (e) {
        console.error('Error loading data:', e);
        prompts = sampleData;
      }
      populateCategoryFilter();
      renderPrompts();
    }

    function saveData() {
      try {
        localStorage.setItem('promptlib.v1.items', JSON.stringify(prompts));
        localStorage.setItem('promptlib.v1.categories', JSON.stringify(categories));
      } catch (e) {
        console.error('Error saving data:', e);
      }
    }

    // UI functions
    function populateCategoryFilter() {
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '<option>All Categories</option>' + categories.map(cat => `<option>${cat}</option>`).join('');
    }

    function renderPrompts() {
      const container = document.getElementById('promptsContainer');
      const filtered = getFilteredPrompts();
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="card" style="grid-column: span 2;">
            <div class="card-body" style="text-align:center;padding:48px">
              <div style="font-size:48px;margin-bottom:16px">üîç</div>
              <div style="color:var(--text-muted)">No prompts match your current filters</div>
              <button class="button primary" onclick="clearFilters()" style="margin-top:16px">Clear Filters</button>
            </div>
          </div>`;
        return;
      }

      container.innerHTML = filtered.map(prompt => {
        const isExpanded = expandedIds.has(prompt.id);
        const showClampedPrompt = compactMode && !isExpanded && prompt.prompt.length > 200;
        
        return `
          <div class="card">
            <div class="card-header">
              <div style="display:flex;align-items:start;justify-content:space-between;gap:16px">
                <div style="flex:1">
                  <div class="card-title">${escapeHtml(prompt.name)}</div>
                  <div class="card-meta">${escapeHtml(prompt.category)} ‚Ä¢ Updated ${new Date(prompt.updatedAt).toLocaleDateString()}</div>
                </div>
                <div class="action-buttons">
                  <button class="button ghost" onclick="copyPrompt('${prompt.id}')" title="Copy prompt">üìã</button>
                  <button class="button ghost" onclick="editPrompt('${prompt.id}')" title="Edit">‚úèÔ∏è</button>
                  <button class="button ghost" onclick="duplicatePrompt('${prompt.id}')" title="Duplicate">üìë</button>
                  <button class="button danger" onclick="deletePrompt('${prompt.id}')" title="Delete">üóëÔ∏è</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="purpose-text">${escapeHtml(prompt.purpose)}</div>
              
              ${showClampedPrompt ? `
                <div class="clamp">${escapeHtml(prompt.prompt)}</div>
                <button class="button ghost" onclick="toggleExpanded('${prompt.id}')" style="margin-top:8px">Show more ‚Üì</button>
              ` : `
                <pre style="margin:0">${escapeHtml(prompt.prompt)}</pre>
                ${compactMode && prompt.prompt.length > 200 ? `<button class="button ghost" onclick="toggleExpanded('${prompt.id}')" style="margin-top:8px">Show less ‚Üë</button>` : ''}
              `}
              
              ${prompt.notes ? `<div class="notes-text"><strong>Notes:</strong> ${escapeHtml(prompt.notes)}</div>` : ''}
              
              <div class="hstack-wrap" style="margin-top:16px">
                ${prompt.tags.map(tag => `<span class="badge">#${escapeHtml(tag)}</span>`).join('')}
                ${prompt.channels.map(channel => `<span class="badge channel">üìû ${escapeHtml(channel)}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getFilteredPrompts() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const tagFilter = document.getElementById('tagFilter').value.trim();
      const channelFilter = document.getElementById('channelFilter').value;

      return prompts.filter(prompt => {
        if (categoryFilter !== 'All Categories' && prompt.category !== categoryFilter) return false;
        if (tagFilter && !prompt.tags.some(tag => tag.toLowerCase().includes(tagFilter.toLowerCase()))) return false;
        if (channelFilter && !prompt.channels.includes(channelFilter)) return false;
        if (search) {
          const searchText = [prompt.name, prompt.prompt, prompt.purpose, prompt.notes, ...prompt.tags, ...prompt.channels].join(' ').toLowerCase();
          if (!searchText.includes(search)) return false;
        }
        return true;
      });
    }

    function filterPrompts() {
      renderPrompts();
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = 'All Categories';
      document.getElementById('tagFilter').value = '';
      document.getElementById('channelFilter').value = '';
      filterPrompts();
    }

    function toggleCompact() {
      compactMode = document.getElementById('compactToggle').checked;
      renderPrompts();
    }

    function toggleExpanded(id) {
      if (expandedIds.has(id)) {
        expandedIds.delete(id);
      } else {
        expandedIds.add(id);
      }
      renderPrompts();
    }

    // Prompt actions with better feedback
    function copyPrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt && navigator.clipboard) {
        navigator.clipboard.writeText(prompt.prompt).then(() => {
          // Show brief success feedback
          const button = event.target;
          const originalText = button.innerHTML;
          button.innerHTML = '‚úÖ';
          button.style.background = '#dcfce7';
          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
          }, 1000);
        }).catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy to clipboard');
        });
      }
    }

    function deletePrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt && confirm(`Delete "${prompt.name}"?\n\nThis cannot be undone.`)) {
        prompts = prompts.filter(p => p.id !== id);
        saveData();
        renderPrompts();
      }
    }

    function duplicatePrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt) {
        const copy = {
          ...prompt,
          id: uid(),
          name: prompt.name + ' (Copy)',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        prompts.unshift(copy);
        saveData();
        renderPrompts();
      }
    }

    // Editor functions
    function startNew() {
      currentEdit = {
        id: uid(),
        category: categories[0] || 'General',
        name: '',
        purpose: '',
        prompt: '',
        notes: '',
        tags: [],
        channels: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      openEditor();
    }

    function editPrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt) {
        currentEdit = { ...prompt };
        openEditor();
      }
    }

    function openEditor() {
      const modal = document.getElementById('editorModal');
      const title = document.getElementById('modalTitle');
      
      title.innerHTML = prompts.some(p => p.id === currentEdit.id) ? '‚úèÔ∏è Edit Prompt' : '‚ú® New Prompt';
      
      // Populate category dropdown
      const categorySelect = document.getElementById('editCategory');
      categorySelect.innerHTML = categories.map(cat => 
        `<option ${cat === currentEdit.category ? 'selected' : ''}>${cat}</option>`
      ).join('');
      
      // Fill form
      document.getElementById('editName').value = currentEdit.name;
      document.getElementById('editPurpose').value = currentEdit.purpose;
      document.getElementById('editPrompt').value = currentEdit.prompt;
      document.getElementById('editNotes').value = currentEdit.notes;
      document.getElementById('editTags').value = currentEdit.tags.join(', ');
      
      // Channel toggles
      const channelContainer = document.getElementById('channelToggles');
      channelContainer.innerHTML = channels.map(channel => `
        <label class="chip-toggle">
          <input type="checkbox" ${currentEdit.channels.includes(channel) ? 'checked' : ''} data-channel="${channel}"/>
          <span>${channel}</span>
        </label>
      `).join('');
      
      modal.classList.remove('hidden');
    }

    function closeEditor() {
      document.getElementById('editorModal').classList.add('hidden');
      currentEdit = null;
    }

    function savePrompt() {
      if (!currentEdit) return;
      
      const name = document.getElementById('editName').value.trim();
      if (!name) {
        alert('Please enter a prompt name');
        return;
      }
      
      currentEdit.category = document.getElementById('editCategory').value;
      currentEdit.name = name;
      currentEdit.purpose = document.getElementById('editPurpose').value;
      currentEdit.prompt = document.getElementById('editPrompt').value;
      currentEdit.notes = document.getElementById('editNotes').value;
      currentEdit.tags = document.getElementById('editTags').value.split(',').map(s => s.trim()).filter(Boolean);
      
      // Get selected channels
      const channelCheckboxes = document.querySelectorAll('#channelToggles input[type="checkbox"]');
      currentEdit.channels = Array.from(channelCheckboxes).filter(cb => cb.checked).map(cb => cb.dataset.channel);
      
      const exists = prompts.some(p => p.id === currentEdit.id);
      if (exists) {
        const index = prompts.findIndex(p => p.id === currentEdit.id);
        prompts[index] = { ...currentEdit, updatedAt: new Date().toISOString() };
      } else {
        prompts.unshift(currentEdit);
      }
      
      saveData();
      renderPrompts();
      closeEditor();
    }

    // Category management
    function addCategory() {
      const name = prompt('Enter new category name:');
      if (name && name.trim() && !categories.includes(name.trim())) {
        categories.push(name.trim());
        saveData();
        populateCategoryFilter();
      } else if (name && categories.includes(name.trim())) {
        alert('Category already exists');
      }
    }

    // Import/Export with better UX
    function exportAll() {
      downloadJSON('ophelos-prompt-library.json', prompts);
    }

    function exportFiltered() {
      const filtered = getFilteredPrompts();
      downloadJSON('ophelos-prompts-filtered.json', filtered);
    }

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importItems() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (Array.isArray(data)) {
                const newPrompts = data.map(d => ({
                  id: d.id || uid(),
                  category: d.category || 'General',
                  name: d.name || 'Untitled',
                  purpose: d.purpose || '',
                  prompt: d.prompt || '',
                  notes: d.notes || '',
                  tags: Array.isArray(d.tags) ? d.tags : [],
                  channels: Array.isArray(d.channels) ? d.channels : [],
                  createdAt: d.createdAt || new Date().toISOString(),
                  updatedAt: new Date().toISOString()
                }));
                prompts = newPrompts.concat(prompts);
                saveData();
                renderPrompts();
                alert(`Successfully imported ${newPrompts.length} prompts!`);
              } else {
                alert('Expected an array of prompts');
              }
            } catch (error) {
              alert('Invalid JSON file');
              console.error('Import error:', error);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    // Modal event handlers
    document.addEventListener('click', function(e) {
      if (e.target.id === 'editorModal') {
        closeEditor();
      }
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('compactToggle').checked = true;
      loadData();
    });
  </script>
</body>
</html>
