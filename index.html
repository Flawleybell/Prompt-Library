<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prompt Library (No-Install, Full CRUD)</title>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --bg:#fff; --chip:#f3f4f6; --ink:#111827; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .hstack{display:flex;align-items:center;gap:8px}
    .hstack-wrap{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
    .spread{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .button{padding:8px 12px;border:1px solid var(--border);background:#fff;cursor:pointer;border-radius:6px}
    .button:hover{background:#f9fafb}
    .button.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
    .button.primary:hover{background:#374151}
    .button.ghost{border-color:transparent;background:transparent;color:var(--ink);padding-left:0}
    .button.danger{border-color:#ef4444;color:#ef4444;background:#fff}
    .button.danger:hover{background:#fef2f2}
    .input,.select,.textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px}
    .grid{display:grid;gap:16px}
    .two-column-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){ 
      .two-column-grid{grid-template-columns:1fr}
    }
    .card{border:1px solid var(--border);border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .card .card-header{padding:12px 16px;border-bottom:1px solid var(--border)}
    .card .card-body{padding:16px}
    .badge{display:inline-block;background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
    .muted{color:var(--muted);font-size:12px}
    pre,code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .clamp{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;white-space:pre-wrap}
    .chip-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;cursor:pointer;margin:2px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal{max-width:760px;width:100%;background:#fff;border-radius:10px;border:1px solid var(--border);overflow:hidden;max-height:90vh;overflow-y:auto}
    .modal .card-header{border-bottom:1px solid var(--border)}
    
    .logo {
      height: 32px;
      width: auto;
      margin-right: 12px;
    }
    
    .header-title {
      display: flex;
      align-items: center;
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <script>
    // Password protection
    (function() {
      var password = prompt("Enter password to view this page:");
      if (password !== "CIA123") {
        document.body.innerHTML = "<div style='text-align:center;margin-top:100px;font-family:Arial'><h2>Access denied</h2></div>";
        return;
      }
    })();
  </script>

  <div class="container">
    <div class="spread" style="margin-bottom:16px">
      <div class="hstack">
        <div class="header-title">
          <img src="https://flawleybell.github.io/Prompt-Library/logo.svg" alt="Logo" class="logo" />
          <h1 style="margin:0">Prompt Library</h1>
        </div>
        <label class="chip-toggle">
          <input type="checkbox" id="compactToggle" onchange="toggleCompact()"/>
          Compact view
        </label>
      </div>
      <div class="hstack-wrap">
        <button class="button" onclick="addCategory()">Add Category</button>
        <button class="button" onclick="importItems()">Import JSON</button>
        <button class="button" onclick="exportFiltered()">Export filtered</button>
        <button class="button primary" onclick="exportAll()">Export all</button>
        <button class="button" onclick="startNew()">New Prompt</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-header"><div style="font-weight:600">Search & Filter</div></div>
      <div class="card-body grid" style="grid-template-columns:2fr 1fr 1fr 1fr">
        <input class="input" id="searchInput" placeholder="Search name, purpose, prompt, notes, tags…" oninput="filterPrompts()"/>
        <select class="select" id="categoryFilter" onchange="filterPrompts()">
          <option>All</option>
        </select>
        <input class="input" id="tagFilter" placeholder="Tag (exact)" oninput="filterPrompts()"/>
        <select class="select" id="channelFilter" onchange="filterPrompts()">
          <option value="">All channels</option>
          <option>Front</option>
          <option>ElevenLabs</option>
          <option>Voice</option>
          <option>Email</option>
          <option>SMS</option>
          <option>Chat</option>
        </select>
      </div>
    </div>

    <!-- Main Content -->
    <div class="two-column-grid" id="promptsContainer">
      <!-- Prompts will be loaded here -->
    </div>

    <!-- Footer -->
    <div class="muted" style="text-align:center; padding:16px 0 32px">
      Stored locally in your browser. Use Export to back up or share with teammates.
    </div>
  </div>

  <!-- Editor Modal -->
  <div class="modal-backdrop hidden" id="editorModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="card-header spread">
        <div style="font-weight:600" id="modalTitle">New Prompt</div>
        <button class="button" onclick="closeEditor()">Close</button>
      </div>
      <div class="card-body grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label class="muted">Category</label>
          <select class="select" id="editCategory"></select>
        </div>
        <div>
          <label class="muted">Name</label>
          <input class="input" id="editName" placeholder="e.g. IDV – Standard"/>
        </div>
        <div style="grid-column:span 2">
          <label class="muted">Purpose</label>
          <input class="input" id="editPurpose" placeholder="Why this exists"/>
        </div>
        <div style="grid-column:span 2">
          <label class="muted">Prompt</label>
          <textarea class="textarea" rows="7" id="editPrompt" placeholder="The actual text…"></textarea>
        </div>
        <div style="grid-column:span 2">
          <label class="muted">Notes</label>
          <textarea class="textarea" rows="3" id="editNotes" placeholder="Compliance notes, when to use, etc."></textarea>
        </div>
        <div>
          <label class="muted">Tags (comma separated)</label>
          <input class="input" id="editTags" placeholder="intro, compliance, SMS"/>
        </div>
        <div>
          <label class="muted">Channels</label>
          <div class="hstack-wrap" id="channelToggles"></div>
        </div>
        <div style="grid-column:span 2" class="hstack">
          <button class="button" onclick="closeEditor()">Cancel</button>
          <button class="button primary" onclick="savePrompt()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // App state
    let prompts = [];
    let categories = ['IDV','Disputes','Vulnerability','Payments','Closures','Escalations','General'];
    let channels = ['Front','ElevenLabs','Voice','Email','SMS','Chat'];
    let currentEdit = null;
    let compactMode = true;
    let expandedIds = new Set();

    // Sample data
    const sampleData = [
      { 
        id: 'sample-1', 
        category: 'IDV', 
        name: 'IDV – Standard', 
        purpose: 'Confirm identity before account details.', 
        prompt: 'For security, I need to confirm a few details before we continue. Could you please confirm your surname?', 
        notes: 'Use after intro, before giving any account details.', 
        tags: ['compliance', 'intro'], 
        channels: ['Voice', 'Front'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      },
      { 
        id: 'sample-2', 
        category: 'Disputes', 
        name: 'Balance not recognised – holding', 
        purpose: 'Acknowledge and move to dispute flow without defensiveness.', 
        prompt: 'Thanks for letting me know. I won\'t go into details until this is checked. I can raise a dispute so the team can investigate. Could you tell me briefly what doesn\'t look right?', 
        notes: 'Keep neutral; capture summary + evidence.', 
        tags: ['dispute', 'holding'], 
        channels: ['Voice', 'Chat'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      },
      { 
        id: 'sample-3', 
        category: 'Vulnerability', 
        name: 'TEXAS – consent line', 
        purpose: 'Gain explicit consent to note circumstances.', 
        prompt: 'So that we can support you in the best way going forward, would it be okay for us to make a note of your circumstances on your account? This information may be shared with {Client} and you can ask us to remove this information at any time, just let us know.', 
        notes: 'Exact wording per internal guidance.', 
        tags: ['vulnerability', 'consent', 'TEXAS'], 
        channels: ['Voice', 'Front', 'Chat'], 
        createdAt: new Date().toISOString(), 
        updatedAt: new Date().toISOString() 
      }
    ];

    // Utility functions
    function uid() { 
      return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 10); 
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Data management
    function loadData() {
      try {
        const saved = localStorage.getItem('promptlib.v1.items');
        prompts = saved ? JSON.parse(saved) : sampleData;
        const savedCats = localStorage.getItem('promptlib.v1.categories');
        if (savedCats) categories = JSON.parse(savedCats);
      } catch (e) {
        console.error('Error loading data:', e);
        prompts = sampleData;
      }
      populateCategoryFilter();
      renderPrompts();
    }

    function saveData() {
      try {
        localStorage.setItem('promptlib.v1.items', JSON.stringify(prompts));
        localStorage.setItem('promptlib.v1.categories', JSON.stringify(categories));
      } catch (e) {
        console.error('Error saving data:', e);
      }
    }

    // UI functions
    function populateCategoryFilter() {
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '<option>All</option>' + categories.map(cat => `<option>${cat}</option>`).join('');
    }

    function renderPrompts() {
      const container = document.getElementById('promptsContainer');
      const filtered = getFilteredPrompts();
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="card" style="grid-column: span 2;"><div class="card-body muted">No prompts match your filters.</div></div>';
        return;
      }

      container.innerHTML = filtered.map(prompt => {
        const isExpanded = expandedIds.has(prompt.id);
        const showClampedPrompt = compactMode && !isExpanded && prompt.prompt.length > 150;
        
        return `
          <div class="card">
            <div class="card-header">
              <div class="spread">
                <div>
                  <div style="font-size:18px; font-weight:600">${escapeHtml(prompt.name)}</div>
                  <div class="muted">${escapeHtml(prompt.category)} • Updated ${new Date(prompt.updatedAt).toLocaleString()}</div>
                </div>
                <div class="hstack">
                  <button class="button ghost" onclick="copyPrompt('${prompt.id}')" title="Copy full prompt">Copy</button>
                  <button class="button ghost" onclick="editPrompt('${prompt.id}')" title="Edit">Edit</button>
                  <button class="button ghost" onclick="duplicatePrompt('${prompt.id}')" title="Duplicate">Duplicate</button>
                  <button class="button danger" onclick="deletePrompt('${prompt.id}')" title="Delete">Delete</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="muted" style="margin-bottom:8px">${escapeHtml(prompt.purpose)}</div>
              
              ${showClampedPrompt ? `
                <div class="clamp" style="font-size:14px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Liberation Mono',monospace">${escapeHtml(prompt.prompt)}</div>
                <button class="button ghost" onclick="toggleExpanded('${prompt.id}')">Show more</button>
              ` : `
                <pre style="white-space:pre-wrap; font-size:14px; margin:0">${escapeHtml(prompt.prompt)}</pre>
                ${compactMode && prompt.prompt.length > 150 ? `<button class="button ghost" onclick="toggleExpanded('${prompt.id}')">Show less</button>` : ''}
              `}
              
              ${prompt.notes ? `<div class="muted" style="margin-top:8px">Notes: ${escapeHtml(prompt.notes)}</div>` : ''}
              <div class="hstack-wrap" style="margin-top:8px">
                ${prompt.tags.map(tag => `<span class="badge">${escapeHtml(tag)}</span>`).join('')}
                ${prompt.channels.map(channel => `<span class="badge">${escapeHtml(channel)}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getFilteredPrompts() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const tagFilter = document.getElementById('tagFilter').value.trim();
      const channelFilter = document.getElementById('channelFilter').value;

      return prompts.filter(prompt => {
        if (categoryFilter !== 'All' && prompt.category !== categoryFilter) return false;
        if (tagFilter && !prompt.tags.includes(tagFilter)) return false;
        if (channelFilter && !prompt.channels.includes(channelFilter)) return false;
        if (search) {
          const searchText = [prompt.name, prompt.prompt, prompt.purpose, prompt.notes, ...prompt.tags, ...prompt.channels].join(' ').toLowerCase();
          if (!searchText.includes(search)) return false;
        }
        return true;
      });
    }

    function filterPrompts() {
      renderPrompts();
    }

    function toggleCompact() {
      compactMode = document.getElementById('compactToggle').checked;
      renderPrompts();
    }

    function toggleExpanded(id) {
      if (expandedIds.has(id)) {
        expandedIds.delete(id);
      } else {
        expandedIds.add(id);
      }
      renderPrompts();
    }

    // Prompt actions
    function copyPrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt && navigator.clipboard) {
        navigator.clipboard.writeText(prompt.prompt).then(() => {
          // Optional: show feedback
        }).catch(err => {
          console.error('Failed to copy:', err);
        });
      }
    }

    function deletePrompt(id) {
      if (confirm('Delete this prompt?')) {
        prompts = prompts.filter(p => p.id !== id);
        saveData();
        renderPrompts();
      }
    }

    function duplicatePrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt) {
        const copy = {
          ...prompt,
          id: uid(),
          name: prompt.name + ' (copy)',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        prompts.unshift(copy);
        saveData();
        renderPrompts();
      }
    }

    // Editor functions
    function startNew() {
      currentEdit = {
        id: uid(),
        category: categories[0] || 'General',
        name: '',
        purpose: '',
        prompt: '',
        notes: '',
        tags: [],
        channels: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      openEditor();
    }

    function editPrompt(id) {
      const prompt = prompts.find(p => p.id === id);
      if (prompt) {
        currentEdit = { ...prompt };
        openEditor();
      }
    }

    function openEditor() {
      const modal = document.getElementById('editorModal');
      const title = document.getElementById('modalTitle');
      
      title.textContent = prompts.some(p => p.id === currentEdit.id) ? 'Edit Prompt' : 'New Prompt';
      
      // Populate category dropdown
      const categorySelect = document.getElementById('editCategory');
      categorySelect.innerHTML = categories.map(cat => 
        `<option ${cat === currentEdit.category ? 'selected' : ''}>${cat}</option>`
      ).join('');
      
      // Fill form
      document.getElementById('editName').value = currentEdit.name;
      document.getElementById('editPurpose').value = currentEdit.purpose;
      document.getElementById('editPrompt').value = currentEdit.prompt;
      document.getElementById('editNotes').value = currentEdit.notes;
      document.getElementById('editTags').value = currentEdit.tags.join(', ');
      
      // Channel toggles
      const channelContainer = document.getElementById('channelToggles');
      channelContainer.innerHTML = channels.map(channel => `
        <label class="chip-toggle">
          <input type="checkbox" ${currentEdit.channels.includes(channel) ? 'checked' : ''} data-channel="${channel}"/>
          ${channel}
        </label>
      `).join('');
      
      modal.classList.remove('hidden');
    }

    function closeEditor() {
      document.getElementById('editorModal').classList.add('hidden');
      currentEdit = null;
    }

    function savePrompt() {
      if (!currentEdit) return;
      
      const name = document.getElementById('editName').value.trim();
      if (!name) {
        alert('Please enter a name');
        return;
      }
      
      currentEdit.category = document.getElementById('editCategory').value;
      currentEdit.name = name;
      currentEdit.purpose = document.getElementById('editPurpose').value;
      currentEdit.prompt = document.getElementById('editPrompt').value;
      currentEdit.notes = document.getElementById('editNotes').value;
      currentEdit.tags = document.getElementById('editTags').value.split(',').map(s => s.trim()).filter(Boolean);
      
      // Get selected channels
      const channelCheckboxes = document.querySelectorAll('#channelToggles input[type="checkbox"]');
      currentEdit.channels = Array.from(channelCheckboxes).filter(cb => cb.checked).map(cb => cb.dataset.channel);
      
      const exists = prompts.some(p => p.id === currentEdit.id);
      if (exists) {
        const index = prompts.findIndex(p => p.id === currentEdit.id);
        prompts[index] = { ...currentEdit, updatedAt: new Date().toISOString() };
      } else {
        prompts.unshift(currentEdit);
      }
      
      saveData();
      renderPrompts();
      closeEditor();
    }

    // Category management
    function addCategory() {
      const name = prompt('New category name');
      if (name && name.trim() && !categories.includes(name.trim())) {
        categories.push(name.trim());
        saveData();
        populateCategoryFilter();
      } else if (name && categories.includes(name.trim())) {
        alert('Category already exists');
      }
    }

    // Import/Export
    function exportAll() {
      downloadJSON('prompt-library.json', prompts);
    }

    function exportFiltered() {
      downloadJSON('prompt-library-filtered.json', getFilteredPrompts());
    }

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importItems() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (Array.isArray(data)) {
                const newPrompts = data.map(d => ({
                  id: d.id || uid(),
                  category: d.category || 'General',
                  name: d.name || 'Untitled',
                  purpose: d.purpose || '',
                  prompt: d.prompt || '',
                  notes: d.notes || '',
                  tags: Array.isArray(d.tags) ? d.tags : [],
                  channels: Array.isArray(d.channels) ? d.channels : [],
                  createdAt: d.createdAt || new Date().toISOString(),
                  updatedAt: new Date().toISOString()
                }));
                prompts = newPrompts.concat(prompts);
                saveData();
                renderPrompts();
              } else {
                alert('Expected an array of prompts');
              }
            } catch (error) {
              alert('Invalid JSON file');
              console.error('Import error:', error);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    // Modal event handlers
    document.addEventListener('click', function(e) {
      if (e.target.id === 'editorModal') {
        closeEditor();
      }
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('compactToggle').checked = true;
      loadData();
    });
  </script>
</body>
</html>
